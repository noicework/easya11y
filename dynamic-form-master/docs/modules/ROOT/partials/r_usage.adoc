= Usage

include::product-docs:ROOT:partial$developing/templating/c_features-avail-and-diffs-of-render-types.adoc[tags="freemarker-vs-headless"]

This functionality has 4 modules and each of them adds different features.

<<Form Core>>::
* Allows saving forms in an external SQL Database
* Dialogs and templates to render forms
* Templating function `formfn`

<<Form App>>::
* Forms a content app
* Rules creation for conversational forms (headless only)
* Dialog Chooser
* Form Results
* Analytics and Graphs

<<Form Bootstrap>>::
* Allows bootstrapping of yaml form files

<<Form Rest>>::
* API Rest
* Delivery Endpoint
* Http client

== Form Core

To function properly, this module requires configurations in *module configuration* locations. Configurations can be located in a JCR config node, `config.yaml` file, or through decorations. Alternatively, configuration for the module can be set in magnolia.properties file.

We need to pass database connection info to the module.

This is the minimum configuration that needs to be passed to the module so it can connect to a database instance:

[tabs]
====
Format::
+
--
[source,yaml]
----
datasource:
  username: [db_user]
  password: [db_assword]
  url: [db_url]
  driver: [db_driver]
  migration:
    path: form-core/dbmigration/[db_type]
    run: [true/false]
----
--
Example::
+
--
[source,yaml]
----
datasource:
  username: user
  password: password
  url: jdbc:mysql://127.0.0.1:3306/forms
  driver: com.mysql.cj.jdbc.Driver
  migration:
    path: form-core/dbmigration/mysql
    run: true
----
--
====

=== Decorated configurations

.<light-module-name>/decorations/form-core/config.yaml
[source,yaml]
----
datasource:
  username: user
  password: password
  url: jdbc:mysql://127.0.0.1:3306/forms
  driver: com.mysql.cj.jdbc.Driver
  migration:
    path: form-core/dbmigration/mysql
    run: true
----

=== Using magnolia (system) properties

magnolia.properties
[source,properties]
----
magnolia.form.datasource.db.username = user
magnolia.form.datasource.db.password = password
magnolia.form.datasource.db.url = jdbc:mysql://127.0.0.1:3306/forms
magnolia.form.datasource.db.driver = com.mysql.cj.jdbc.Driver
magnolia.form.ebean.migration.path = form-core/dbmigration/mysql
magnolia.form.ebean.migration.run = true
----

[TIP]
====
For bootstraping forms entities to work properly (when using *info.magnolia.form.module.BootstrapFormTask*) configure database connection parameters in *magnolia.properties*
====

[TIP]
====
If you have an error like:

[source]
----
"Error initialising DataSource: The server time zone value 'CEST' is unrecognized or represents more than one time zone. You must configure either the server or JDBC driver"
----

Add the following code to your url property in the config.yaml file: "?serverTimezone=Europe/Madrid" or your personal time zone.
====

All properties that are prefixed with "form" are passed to the ebean server. This way we can easily tune ebean ORM framework.

NOTE: More info on Ebean ORM is available on this link:https://ebean.io/docs/[ebean document^].

=== Database requirements

This module does not create a database. A database `MUST EXISTS` and database user has to have also `CREATE/DROP/ALTER RIGHTS` on that database.

For the database connection to work, we need an appropriate database driver to be available on the classpath. For example: if we are using MySQL database with Tomcat server we need to place "mysql-connector-java-8.0.18.jar" in Tomcat lib folder.

The table(s) required are created automatically by the init scripts in the magnolia-form-core module. For these scripts to be executed the first time the module is installed (or whenever the database is empty) the migration node in the datasource is used:

* `path`: The path of the init script.
** `form-core/dbmigration/mysql` for MySQL schema
** `form-core/dbmigration/pg` for PostgreSQL schema
* `run`: this property needs to be true to initialize or migrate database. Default value: true


==== Dynamic content

Version `1.1.0` introduced dynamic content which let you storing extra fields dynamically within the form related entities. This can be done by decorating the following definitions of form-app module:

* `form-edit.yaml`
* `question-edit.yaml`
* `answer-edit.yaml`
* `section-edit.yaml`

New fields can be defined, they must be prefixed by "content.", like in below example:

.<light-module-name>/decorations/form-app/forms.yaml
[source,yaml]
----
form:
  properties:
    - name: content.emailValidator <1>
      $type: textField

  layout:
    $type: tabbedLayout
    tabs:
      validators:
        fields:
          - name: content.emailValidator <1>
----
<1> Example of the `content.` prefix.

CAUTION: Complex fields like xref:product-docs:ROOT:Developing/Templating/Dialog-definition/Field-definition/List-of-fields/Multi-field.adoc[], xref:product-docs:ROOT:Developing/Templating/Dialog-definition/Field-definition/List-of-fields/Composite-field.adoc[] or xref:product-docs:ROOT:Developing/Templating/Dialog-definition/Field-definition/List-of-fields/Switchable-field.adoc[] are currently not supported in dynamic content fields.

=== Dialogs and templates

The `form-core` module provides sample dialogues and templates for rendering forms.

If you want to use a field to select forms, you must add the following to your dialog definition:

.<light-module-name>/dialogs/component/form-manual.yaml
[source,yaml]
----
form:
  properties:

    - name: formId
      label: Form
      $type: linkField
      required: true
      converterClass: info.magnolia.form.field.converter.FormToStringConverter
      placeholder: Choose form
      chooser:
        workbenchChooser:
          appName: forms-chooser
----

The templates included are the following:

* `form.yaml`
* `form-manual.yaml`
* `forms.yaml`
* `results.yaml`
* `results-manual.yaml`

=== Templating function `formfn`

`formfn`: `info.magnolia.form.functions.FormFunctions`

Methods::

* `public List<FormDto> getForms()`
* `public FormDto getForm(long id) `
* `public ResponseDto submitResponse(final long id, final List<ResponseItemDto> formResponseItemDtoList)`
* `public Collection<ResponseDto> getResults(long id)`

== Form App

The Form App lets you browse and manage forms from Magnolia's custom content Application. 
The app is dependent on Form Core module.

You can access the app through the App launcher.

image::applauncher-formIcon-formApp.jpg[role=zoom]

=== Create a form

Create a form by clicking the "Add form" command from the action bar.

When creating a form, besides the form title and description there are three additional option fields available:

* Anonymize results: If "Anonymize results" is checked, all form answers will be saved as answered by an anonymous user.
* Only authorized: If "Only authorized" is checked, unauthorized users (anonymous) will not be allowed to post form answers.
* Public results: If "Public results" is checked, results for this form will be available over the rest endpoint.

The `Form rules` tab provides a way to store rules between questions. The rules can be used in a headless context, they are returned by the get form rest service and let you then render the poll frontend according to the rules.

image::create-form.png[width=600,role=zoom]

=== Multiple sections

Add Section(s) to form by selecting a form in the grid and clicking the "Add section" command from the action bar.

image::form-add-section.jpg[width=600,role=zoom]

=== Multiple questions

Question(s) can be added to a Section or directly to the form (In case there is no need to structure questions in sections). Add question(s) to section/form by selecting a section/form in the grid and clicking the "Add question" command from the action bar.

A Question can be one of four types:

* Free text
* Multi select
* Range
* Single select

NOTE: If the Question is of type: Single or Multi select then the user should add multiple "Answer options" to this question.

image::form-add-question.jpg[width=600,role=zoom]

=== Answer options

Add answer option(s) to a Question by selecting a Question in the grid and clicking "Add answer option" command from the action bar.

An Answer can be one of two types:

* Don't show free text option
* Show free text option: "Show free text option" allows you to add an "empty field" to add a free text option in a list of possible answers.

image::add-answer-options.jpg[width=600,role=zoom]

=== Form rules

Adding rules to your forms helps intelligently guide users to more relevant questions.
For example, if you would like prospective insurance customers to go to age-appropriate questions.

NOTE: To create a rule, you must have questions within an existing form.
Otherwise, there's nowhere for the rule to direct the user as part of the flow.

To add rule(s) to a form:

. Go to the *Forms* app in AdminCentral.
. Choose an existing form, and click *Edit Form* in the action bar.
. Go to the *Form rules* tab.
. Click *icon:plus[] Add new rule*.
. Define the rule conditions.
+
The example here directs users under 25 years old to an age-appropriate follow-up question.
+
image:form-question-rules.jpg[role=zoom]

=== Form Results

We can view form results by selecting a form in the forms custom content app and clicking on the "View Results" command from the action bar.
Form results sub-app will be open where all form results are listed. Form results are grouped by user and date:

image::form-results.jpg[width=600,role=zoom]

=== Form Analytics

We can view form results in more advanced representation by selecting a form in the forms custom content app and clicking on the "View analytics" command from the action bar.

The Chart type used to represent form results is based on the question type.

* Single select question is represented with Pie chart by default.
* Multi select question is represented with Bar chart by default.
* The For Free text question chart is not generated, only a detailed answer grid is shown in the analytics view.

Form analytics sub-app will be open where all form results are listed, represented with Chart views:

image::form-analytics.jpg[width=600,role=zoom]

TIP: We can view/search answers for each question by clicking on the "Show details" button under the chart/question.

==== Graph customization

For each of the question types there is already predefined (configured) default chart. Predefined charts definitions can be found in resources app at "/form-app/charts/forms".
Charts can be customized by directly modifying the chart definition yaml files or by using decorations.

TIP: Form more information regarding magnolia charts you can check link:https://docs.magnolia-cms.com/product-docs/6.2/Connector-Packs/Analytics-Connector-Pack/Analytics-module.html[the documentation^] .

Also, there is possibility to use a custom chart definition for each of the form questions. This can be achieved by setting the value of the "Custom chart id" field in the question dialog to the custom chart definition:

image::custom-chart-id-field.png[width=600,role=zoom]

Let's see an example:

This is default chart for range question type:

image::default-range-chart.png[width=600,role=zoom]

This is default range chart definition (/form-app/charts/forms/range.yaml):

[source, yaml]
----
class: info.magnolia.analytics.amcharts.data.AmChartDefinition
label: dashboard.chart.simple-bar
chartType:
  class: info.magnolia.analytics.amcharts.data.configuration.AmChartType
  type: XYChart
  series:
    - name: series
      type: ColumnSeries
      dataFields:
      - name: categoryY
        value: answer
        jsonPath: $.[*].answer
      - name: valueX
        value: average
        jsonPath: $.[*].average
      - name: count
        value: count
        jsonPath: $.[*].count
      - name: total
        value: total
        jsonPath: $.[*].total
      tooltipText: '"Total:{total}  Count:{count}  [bold]Average:{valueX}[/]"'
      columns:
        strokeWidth: 0
        strokeOpacity: 1
  xAxes:
    - name: xaxe
      type: VALUE_AXIS
  yAxes:
    - name: yaxe
      type: CATEGORY_AXIS
      renderer:
        minGridDistance: 10
        grid:
          location: 0
      dataFields:
        category: answer
  cursor:
    type: XYCursor

----

Let's create new chart definition (/form-app/charts/forms/range-custom.yaml) with following content:

[source, yaml]
----
class: info.magnolia.analytics.amcharts.data.AmChartDefinition
label: dashboard.chart.3d-column
# Here is sample config for https://www.amcharts.com/demos/3d-column-chart/
chartType:
  class: info.magnolia.analytics.amcharts.data.configuration.AmChartType
  type: XYChart3D
  series:
    - name: series
      type: ColumnSeries3D
      dataFields:
      - name: categoryX
        value: answer
        jsonPath: $.[*].answer
      - name: valueY
        value: average
        jsonPath: $.[*].average
      - name: count
        value: count
        jsonPath: $.[*].count
      - name: total
        value: total
        jsonPath: $.[*].total
      tooltipText: '"Total:{total}  Count:{count}  [bold]Average:{valueY}[/]"'
      columns:
        strokeWidth: 2
        strokeOpacity: 1
  xAxes:
    - name: xaxe
      type: CATEGORY_AXIS
      renderer:
        minGridDistance: 30
        grid:
          location: 0
        labels:
          truncate: true
          maxWidth: 90
      dataFields:
        category: average
  yAxes:
    - name: yaxe
      type: VALUE_AXIS
  cursor:
    type: XYCursor

----

Set "Custom chart id" field value to the name of the new file created: "range-custom"

image::custom-chart-id-field-set.png[width=600,role=zoom]

If we open form analytics we can see that graph for range question is changed:

image::custom-range-chart.png[width=600,role=zoom]

== Form Bootstrap

The Form Bootstrap module provides a way to bootstrap yaml form files at startup, previously exported from a Magnolia form app. Default configuration is monitoring resource folder `/form-bootstrap/forms`
You can change this folder by decorating form-bootstrap config `/your_module/decorations/form-bootstrap/config.yaml`.

[source,yaml]
----
bootstrapFolderLocation: /your/own/path
----

Create the directory structure within the resource directory, either `/form-bootstrap/forms` or `/your/own/path` in case you have decorated the configuration.
Add the yaml files you want to bootstrap in the defined bootstrap folder.


== Form Rest

The Form Rest module provides a rest API that can be used to manage forms (CRUD operations). This module is dependent on the Form Core module.

Path:: `/.rest/forms/v1`

* <<Get all forms>>
* <<Get a specific form>>
* <<Post a form>>
* <<Get form results>>

// get all forms
include::partial$api/r_get-all-forms.adoc[leveloffset=+2]

// get specific form
include::partial$api/r_get-form.adoc[leveloffset=+2]

// create form
include::partial$api/r_post-form.adoc[leveloffset=+2]

// get form results
include::partial$api/r_get-form-results.adoc[leveloffset=+2]
