<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Scan Results</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .scan-container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }
        
        .scan-status {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .scan-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1em;
            color: #068449;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #068449;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .results-header {
            padding: 20px 20px 0 20px;
            flex-shrink: 0;
        }
        
        .score-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .score-circle-container {
            flex-shrink: 0;
            text-align: center;
        }
        
        .score-circle {
            width: 100px;
            height: 100px;
            margin: 0 auto 10px;
            position: relative;
        }
        
        .score-circle svg {
            transform: rotate(-90deg);
        }
        
        .score-circle-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 10;
        }
        
        .score-circle-progress {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
        }
        
        .score-label {
            font-size: 1.1em;
            color: #6c757d;
        }
        
        .stats-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.95em;
        }
        
        .stat-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .violations-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0 20px 20px 20px;
        }
        
        #violationsList {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .violations-header {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .violation-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .violation-title {
            font-weight: 500;
            color: #333;
            flex: 1;
        }
        
        .impact-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .impact-critical {
            background-color: #dc3545;
            color: white;
        }
        
        .impact-serious {
            background-color: #fd7e14;
            color: white;
        }
        
        .impact-moderate {
            background-color: #ffc107;
            color: #333;
        }
        
        .impact-minor {
            background-color: #6c757d;
            color: white;
        }
        
        .violation-description {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .violation-elements {
            margin-top: 10px;
            font-size: 0.85em;
        }
        
        .element-item {
            background: #f8f9fa;
            border-left: 3px solid #068449;
            padding: 8px 12px;
            margin-bottom: 5px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85em;
            overflow-x: auto;
        }
        
        .show-more-elements {
            color: #068449;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.85em;
            margin-top: 5px;
            display: inline-block;
        }
        
        .show-more-elements:hover {
            color: #0a5932;
        }
        
        .elements-collapsed {
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="scan-container">
        <div class="scan-status" id="scanStatus">
            <div class="scan-progress">
                <div class="spinner"></div>
                <span>Running accessibility scan...</span>
            </div>
        </div>
        
        <div class="results-container hidden" id="resultsContainer">
            <div class="results-header">
                <div class="score-section">
                    <div class="score-circle-container">
                        <div class="score-circle">
                            <svg width="100" height="100">
                                <circle cx="50" cy="50" r="40" class="score-circle-bg"></circle>
                                <circle cx="50" cy="50" r="40" class="score-circle-progress" id="scoreCircle"></circle>
                            </svg>
                            <div class="score-text" id="scoreText">0</div>
                        </div>
                        <div class="score-label">Accessibility Score</div>
                    </div>
                    
                    <div class="stats-list">
                        <div class="stat-row">
                            <span class="stat-label">Violations</span>
                            <span class="stat-value" id="violationCount">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Passed Rules</span>
                            <span class="stat-value" id="passCount">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Issues Found</span>
                            <span class="stat-value" id="issueCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="violations-section" id="violationsSection">
                <h2 class="violations-header">
                    <span>Accessibility Issues</span>
                    <span id="violationsSummary"></span>
                </h2>
                <div id="violationsList"></div>
            </div>
        </div>
        
        <div class="error-message hidden" id="errorMessage"></div>
    </div>
    
    <script src="js/easya11y.js"></script>
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const pageUrl = urlParams.get('pageUrl');
        const scanId = urlParams.get('scanId');
        const pagePath = urlParams.get('pagePath');
        const pageTitle = urlParams.get('pageTitle') || 'Unknown Page';
        const wcagLevel = urlParams.get('wcagLevel') || 'AA';
        
        // Get context path
        const baseUrl = window.location.origin;
        const pathParts = window.location.pathname.split('/');
        const contextPath = pathParts[1] === 'magnoliaAuthor' ? '/magnoliaAuthor' : '';
        const apiBase = `${baseUrl}${contextPath}/.rest`;
        
        // Initialize scanner
        let scanner = null;
        
        // DOM elements
        const scanStatusEl = document.getElementById('scanStatus');
        const resultsContainerEl = document.getElementById('resultsContainer');
        const errorMessageEl = document.getElementById('errorMessage');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize scanner and start scan
            if (window.AccessibilityScanner) {
                scanner = new window.AccessibilityScanner(apiBase);
                startScan();
            } else {
                showError('Scanner initialization failed');
            }
        });
        
        async function startScan() {
            try {
                const results = await scanner.scanPage({
                    scanId: scanId,
                    pagePath: pagePath,
                    pageUrl: pageUrl,
                    pageTitle: pageTitle,
                    wcagLevel: wcagLevel
                });
                displayResults(results);
            } catch (error) {
                console.error('Scan error:', error);
                showError('Scan failed: ' + error.message);
            }
        }
        
        function displayResults(results) {
            // Hide scanning status
            scanStatusEl.classList.add('hidden');
            resultsContainerEl.classList.remove('hidden');
            
            // Calculate score based on violations and passes
            const violationCount = results.violations?.length || 0;
            const passCount = results.passes?.length || 0;
            const totalRules = violationCount + passCount;
            
            // Calculate a simple percentage score
            let score = 0;
            if (totalRules > 0) {
                score = Math.round((passCount / totalRules) * 100);
            }
            
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            
            // Set score color based on value
            let scoreColor;
            if (score >= 90) scoreColor = '#28a745';
            else if (score >= 70) scoreColor = '#ffc107';
            else if (score >= 50) scoreColor = '#fd7e14';
            else scoreColor = '#dc3545';
            
            scoreCircle.style.stroke = scoreColor;
            scoreText.style.color = scoreColor;
            scoreText.textContent = score;
            
            // Animate score circle (radius is now 40)
            const circumference = 2 * Math.PI * 40;
            scoreCircle.style.strokeDasharray = circumference;
            scoreCircle.style.strokeDashoffset = circumference - (score / 100) * circumference;
            
            // Display stats
            const totalIssues = results.violations?.reduce((sum, v) => sum + (v.nodes?.length || 0), 0) || 0;
            
            document.getElementById('violationCount').textContent = violationCount;
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('issueCount').textContent = totalIssues;
            
            // Display violations
            if (results.violations && results.violations.length > 0) {
                displayViolations(results.violations);
            } else {
                document.getElementById('violationsSection').innerHTML = `
                    <div class="success-message">
                        <strong>Great job!</strong> No accessibility violations found.
                    </div>
                `;
            }
        }
        
        function displayViolations(violations) {
            const violationsList = document.getElementById('violationsList');
            const violationsSummary = document.getElementById('violationsSummary');
            
            // Group by impact
            const byImpact = {
                critical: violations.filter(v => v.impact === 'critical'),
                serious: violations.filter(v => v.impact === 'serious'),
                moderate: violations.filter(v => v.impact === 'moderate'),
                minor: violations.filter(v => v.impact === 'minor')
            };
            
            // Update summary
            const summaryParts = [];
            if (byImpact.critical.length) summaryParts.push(`${byImpact.critical.length} critical`);
            if (byImpact.serious.length) summaryParts.push(`${byImpact.serious.length} serious`);
            if (byImpact.moderate.length) summaryParts.push(`${byImpact.moderate.length} moderate`);
            if (byImpact.minor.length) summaryParts.push(`${byImpact.minor.length} minor`);
            violationsSummary.textContent = `(${summaryParts.join(', ')})`;
            
            // Clear and populate violations
            violationsList.innerHTML = '';
            
            // Display violations by impact level
            ['critical', 'serious', 'moderate', 'minor'].forEach(impact => {
                byImpact[impact].forEach(violation => {
                    const card = createViolationCard(violation);
                    violationsList.appendChild(card);
                });
            });
        }
        
        function createViolationCard(violation) {
            const card = document.createElement('div');
            card.className = 'violation-card';
            
            // Generate unique ID for this violation
            const violationId = 'violation-' + Math.random().toString(36).substr(2, 9);
            
            // Show first 3 elements
            const visibleElements = violation.nodes.slice(0, 3).map(node => 
                `<div class="element-item">${escapeHtml(node.target || node.html)}</div>`
            ).join('');
            
            // Hidden elements (after the first 3)
            const hiddenElements = violation.nodes.length > 3 ? 
                violation.nodes.slice(3).map(node => 
                    `<div class="element-item elements-collapsed" data-violation="${violationId}">${escapeHtml(node.target || node.html)}</div>`
                ).join('') : '';
            
            // "Show more" link
            const showMoreLink = violation.nodes.length > 3 ? 
                `<span class="show-more-elements" data-violation="${violationId}" data-expanded="false">
                    ... and ${violation.nodes.length - 3} more elements
                </span>` : '';
            
            card.innerHTML = `
                <div class="violation-header">
                    <div class="violation-title">${escapeHtml(violation.help)}</div>
                    <span class="impact-badge impact-${violation.impact}">${violation.impact}</span>
                </div>
                <div class="violation-description">${escapeHtml(violation.description)}</div>
                <div class="violation-elements">
                    <strong>Affected elements:</strong>
                    ${visibleElements}
                    ${hiddenElements}
                    ${showMoreLink}
                </div>
            `;
            
            // Add click handler for show more
            const showMoreElement = card.querySelector('.show-more-elements');
            if (showMoreElement) {
                showMoreElement.addEventListener('click', function() {
                    const violationId = this.getAttribute('data-violation');
                    const hiddenElements = card.querySelectorAll(`.elements-collapsed[data-violation="${violationId}"]`);
                    const isExpanded = this.getAttribute('data-expanded') === 'true';
                    
                    if (isExpanded) {
                        // Collapse
                        hiddenElements.forEach(el => el.style.display = 'none');
                        this.textContent = `... and ${violation.nodes.length - 3} more elements`;
                        this.setAttribute('data-expanded', 'false');
                    } else {
                        // Expand
                        hiddenElements.forEach(el => el.style.display = 'block');
                        this.textContent = 'Show less';
                        this.setAttribute('data-expanded', 'true');
                    }
                });
            }
            
            return card;
        }
        
        function showError(message) {
            scanStatusEl.classList.add('hidden');
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>